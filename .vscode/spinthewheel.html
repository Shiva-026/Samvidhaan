<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constitution Spin Wheel</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 30px;
            text-align: center;
        }

        .wheel-container {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 0 auto 30px;
        }

        #wheelCanvas {
            width: 100%;
            height: 100%;
            border: 8px solid #4a5568;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            background: white;
        }

        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #e53e3e;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
            z-index: 10;
        }

        #spinButton {
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: #4a5568;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        #spinButton:hover {
            background-color: #2d3748;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        #spinButton:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }

        #resultContainer {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: none;
            margin-top: 20px;
        }

        .question {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .option {
            padding: 12px 15px;
            background-color: #f8f9fa;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .option:hover {
            background-color: #edf2f7;
            border-color: #cbd5e0;
        }

        .option.selected {
            background-color: #4299e1;
            color: white;
            border-color: #3182ce;
        }

        .option.correct {
            background-color: #48bb78;
            color: white;
            border-color: #38a169;
        }

        .option.incorrect {
            background-color: #f56565;
            color: white;
            border-color: #e53e3e;
        }

        .explanation {
            padding: 15px;
            background-color: #ebf8ff;
            border-left: 4px solid #4299e1;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
        }

        .explanation h3 {
            margin-top: 0;
            color: #2b6cb0;
        }

        .next-btn {
            padding: 10px 20px;
            background-color: #4a5568;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            display: none;
        }

        .score-display {
            font-size: 18px;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 20px;
        }

        .spins-remaining {
            font-size: 16px;
            color: #4a5568;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Constitution Spin Wheel Challenge</h1>
    <div class="score-display" id="scoreDisplay">Score: 0</div>
    <div class="spins-remaining" id="spinsRemainingDisplay">Spins Remaining: 5</div>
    
    <div class="wheel-container">
        <canvas id="wheelCanvas" width="500" height="500"></canvas>
        <div class="wheel-pointer"></div>
    </div>
    
    <button id="spinButton">Spin the Wheel!</button>
    
    <div id="resultContainer">
        <div class="question" id="questionText"></div>
        <div class="options" id="optionsContainer"></div>
        <div class="explanation" id="explanationContainer">
            <h3>Constitutional Explanation</h3>
            <p id="explanationText"></p>
        </div>
        <button class="next-btn" id="nextButton">Next Question</button>
    </div>

    <script>
    // API Configuration
    const API_BASE_URL = 'http://localhost:5000';

    // Canvas and Context
    const wheelCanvas = document.getElementById('wheelCanvas');
    const wheelContext = wheelCanvas.getContext('2d');
    
    // Game Elements
    const spinButton = document.getElementById('spinButton');
    const resultContainer = document.getElementById('resultContainer');
    const questionText = document.getElementById('questionText');
    const optionsContainer = document.getElementById('optionsContainer');
    const explanationContainer = document.getElementById('explanationContainer');
    const explanationText = document.getElementById('explanationText');
    const nextButton = document.getElementById('nextButton');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const spinsRemainingDisplay = document.getElementById('spinsRemainingDisplay');

    // Game State
    let spinsRemaining = 5;
    let isSpinning = false;
    let score = 0;
    let currentTopic = '';
    let currentQuestion = {};
    let selectedOption = null;
    let questionsAnswered = 0;
    let wheelSegments = []; // Will be loaded from API
    let questionsDatabase = {}; // Will store questions by topic
    let usedQuestions = {}; // Track used questions per topic

    // Wheel Properties
    let startAngle = 0;
    let arc = 0;
    let spinTimeout = null;
    let spinAngleStart = 10;
    let spinTime = 0;
    let spinTimeTotal = 0;

    // Initialize Game
    async function initGame() {
        try {
            // Load topics from backend
            const response = await fetch(`${API_BASE_URL}/spin-wheel/topics`);
            const data = await response.json();
            
            if (data.success) {
                wheelSegments = data.topics;
                arc = (2 * Math.PI) / wheelSegments.length;
                
                // Initialize used questions object
                wheelSegments.forEach(topic => {
                    usedQuestions[topic] = [];
                    questionsDatabase[topic] = [];
                });
                
                drawWheel();
                updateSpinsDisplay();
                console.log('Game initialized with topics:', wheelSegments);
            } else {
                console.error('Failed to load topics:', data.message);
                alert('Failed to load game topics. Please try again.');
            }
        } catch (error) {
            console.error('Error initializing game:', error);
            alert('Error initializing game. Please check your connection.');
        }
    }

    // Draw the Wheel
    function drawWheel() {
        if (wheelSegments.length === 0) return;
        
        wheelContext.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
        
        for (let i = 0; i < wheelSegments.length; i++) {
            const angle = startAngle + i * arc;
            
            // Segment color
            wheelContext.fillStyle = getColor(i);
            wheelContext.beginPath();
            wheelContext.arc(250, 250, 200, angle, angle + arc, false);
            wheelContext.lineTo(250, 250);
            wheelContext.fill();
            
            // Segment text
            wheelContext.save();
            wheelContext.translate(250, 250);
            wheelContext.rotate(angle + arc / 2);
            wheelContext.textAlign = "center";
            wheelContext.fillStyle = "white";
            wheelContext.font = "bold 14px Arial";
            
            const text = wheelSegments[i];
            const words = text.split(/(?=[A-Z][a-z])/);
            let lines = [];
            let currentLine = words[0];
            
            for (let j = 1; j < words.length; j++) {
                if ((currentLine + words[j]).length < 10) {
                    currentLine += words[j];
                } else {
                    lines.push(currentLine);
                    currentLine = words[j];
                }
            }
            lines.push(currentLine);
            
            lines.forEach((line, idx) => {
                wheelContext.fillText(
                    line.trim(),
                    120 * Math.cos(0),
                    120 * Math.sin(0) + (idx * 20) - ((lines.length - 1) * 10)
                );
            });
            
            wheelContext.restore();
        }
    }

    // Get Segment Color
    function getColor(index) {
        const colors = ['#e63946', '#457b9d', '#1d3557', '#a8dadc', '#2a9d8f', 
                        '#e9c46a', '#f4a261', '#e76f51', '#264653', '#2a9d8f'];
        return colors[index % colors.length];
    }

    // Rotate Wheel Animation
    function rotateWheel() {
        spinTime += 30;
        if (spinTime >= spinTimeTotal) {
            stopRotateWheel();
            return;
        }
        const spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
        startAngle += (spinAngle * Math.PI / 180);
        drawWheel();
        spinTimeout = setTimeout(rotateWheel, 30);
    }

    // Stop Wheel and Load Question
    async function stopRotateWheel() {
        clearTimeout(spinTimeout);
        isSpinning = false;
        
        const degrees = startAngle * 180 / Math.PI + 90;
        const arcd = arc * 180 / Math.PI;
        const index = Math.floor((360 - degrees % 360) / arcd);
        currentTopic = wheelSegments[index];
        
        spinsRemaining--;
        updateSpinsDisplay();
        
        try {
            await loadAndDisplayQuestion();
        } catch (error) {
            console.error('Error loading question:', error);
            alert('Error loading question. Please try again.');
            spinButton.disabled = false;
        }
    }

    // Load and Display Question from Backend
    async function loadAndDisplayQuestion() {
        try {
            // Show loading state
            questionText.textContent = 'Loading question...';
            optionsContainer.innerHTML = '';
            resultContainer.style.display = 'block';
            
            // Fetch questions for this topic
            const response = await fetch(`${API_BASE_URL}/spin-wheel/questions/${encodeURIComponent(currentTopic)}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message);
            }
            
            // Store questions in database
            questionsDatabase[currentTopic] = data.questions;
            
            // Get a random question that hasn't been used
            const availableQuestions = data.questions.filter(q => !usedQuestions[currentTopic].includes(q.id));
            
            if (availableQuestions.length === 0) {
                // Reset used questions if all have been used
                usedQuestions[currentTopic] = [];
                currentQuestion = data.questions[Math.floor(Math.random() * data.questions.length)];
            } else {
                currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            }
            
            // Mark question as used
            usedQuestions[currentTopic].push(currentQuestion.id);
            
            displayQuestion();
            
        } catch (error) {
            console.error('Error in loadAndDisplayQuestion:', error);
            throw error;
        }
    }

    // Display Question
    function displayQuestion() {
        questionText.textContent = currentQuestion.question_text;
        optionsContainer.innerHTML = '';
        
        // Create options array from database fields
        const options = [
            currentQuestion.option_a,
            currentQuestion.option_b, 
            currentQuestion.option_c,
            currentQuestion.option_d
        ];
        
        options.forEach((option, index) => {
            const optionElement = document.createElement('div');
            optionElement.classList.add('option');
            optionElement.textContent = option;
            optionElement.addEventListener('click', () => selectOption(index));
            optionsContainer.appendChild(optionElement);
        });
        
        resultContainer.style.display = 'block';
        explanationContainer.style.display = 'none';
        nextButton.style.display = 'none';
        selectedOption = null;
        
        // Scroll to result container
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Handle Option Selection
    async function selectOption(optionIndex) {
        if (selectedOption !== null) return;
        
        selectedOption = optionIndex;
        const options = document.querySelectorAll('.option');
        const optionLetters = ['a', 'b', 'c', 'd'];
        const selectedOptionLetter = optionLetters[optionIndex];
        
        // Disable all options while checking
        options.forEach(opt => {
            opt.style.pointerEvents = 'none';
        });
        
        try {
            // Check answer with backend
            const response = await fetch(`${API_BASE_URL}/spin-wheel/check-answer`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    questionId: currentQuestion.id,
                    selectedOption: selectedOptionLetter
                })
            });
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }
            
            // Show results
            options.forEach((opt, idx) => {
                const currentOptionLetter = optionLetters[idx];
                
                if (currentOptionLetter === result.correctAnswer) {
                    opt.classList.add('correct');
                }
                if (idx === optionIndex && !result.correct) {
                    opt.classList.add('incorrect');
                }
                if (idx === optionIndex) {
                    opt.classList.add('selected');
                }
            });
            
            if (result.correct) {
                score += 10;
                scoreDisplay.textContent = `Score: ${score}`;
            }
            
            explanationText.textContent = result.explanation;
            explanationContainer.style.display = 'block';
            nextButton.style.display = 'inline-block';
            
        } catch (error) {
            console.error('Error checking answer:', error);
            alert('Error checking answer. Please try again.');
            
            // Re-enable options on error
            options.forEach(opt => {
                opt.style.pointerEvents = 'auto';
            });
            selectedOption = null;
        }
    }

    // Next Question
    function nextQuestion() {
        resultContainer.style.display = 'none';
        
        if (spinsRemaining <= 0) {
            showFinalScore();
        } else {
            spinButton.disabled = false;
        }
    }

    // Update Spins Display
    function updateSpinsDisplay() {
        spinsRemainingDisplay.textContent = `Spins Remaining: ${spinsRemaining}`;
        
        if (spinsRemaining <= 0) {
            spinButton.disabled = true;
            spinButton.textContent = "Game Over";
        } else {
            spinButton.textContent = `Spin (${spinsRemaining} left)`;
        }
    }

    // Easing Function
    function easeOut(t, b, c, d) {
        const ts = (t /= d) * t;
        const tc = ts * t;
        return b + c * (tc + -3 * ts + 3 * t);
    }

    // Show Final Score
    function showFinalScore() {
        const resultMessage = `Game Complete!\n\nFinal Score: ${score}\n` +
                             `Correct Answers: ${score/10} out of 5`;
        
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';
        
        const modalContent = document.createElement('div');
        modalContent.style.backgroundColor = 'white';
        modalContent.style.padding = '30px';
        modalContent.style.borderRadius = '10px';
        modalContent.style.maxWidth = '500px';
        modalContent.style.textAlign = 'center';
        
        const message = document.createElement('h2');
        message.textContent = resultMessage;
        message.style.marginBottom = '20px';
        message.style.whiteSpace = 'pre-line';
        
        const closeButton = document.createElement('button');
        closeButton.textContent = 'Play Again';
        closeButton.style.padding = '10px 20px';
        closeButton.style.backgroundColor = '#4a5568';
        closeButton.style.color = 'white';
        closeButton.style.border = 'none';
        closeButton.style.borderRadius = '5px';
        closeButton.style.cursor = 'pointer';
        
        closeButton.addEventListener('click', () => {
            document.body.removeChild(modal);
            resetGame();
        });
        
        modalContent.appendChild(message);
        modalContent.appendChild(closeButton);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
    }

    // Reset Game
    function resetGame() {
        score = 0;
        spinsRemaining = 5;
        questionsAnswered = 0;
        scoreDisplay.textContent = `Score: ${score}`;
        updateSpinsDisplay();
        spinButton.disabled = false;
        resultContainer.style.display = 'none';
        
        // Reset used questions
        wheelSegments.forEach(topic => {
            usedQuestions[topic] = [];
        });
    }

    // Event Listeners
    spinButton.addEventListener('click', function() {
        if (isSpinning || spinsRemaining <= 0) return;
        
        isSpinning = true;
        spinButton.disabled = true;
        spinAngleStart = Math.random() * 10 + 10;
        spinTime = 0;
        spinTimeTotal = Math.random() * 3 + 4 * 1000;
        rotateWheel();
    });

    nextButton.addEventListener('click', nextQuestion);

    // Initialize Game when page loads
    window.onload = initGame;
</script>


</body>
</html>